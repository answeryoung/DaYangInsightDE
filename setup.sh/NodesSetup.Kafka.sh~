#!/bin/sh
# NodesSetup.Kafka.sh
# DY200614

read -p 'Kafka Broker ID: ' broker_id

read -p 'Zookeeper ip: 10.0.0.' zkpr_ip

cd ~
echo $PWD
sh getDevTools.sh
sh anoteCluster.sh

# get kafka
wget -c $kafka_bin_url -O - | tar -xz
sudo mv /home/ec2-user/kafka_2.11-2.4.1/    /usr/local/kafka

# edit server.properties
server_prop="/usr/local/kafka/config/server.properties"
log_dir="/home/ec2-user/kafka-logs"
sed -i -e "s/broker.id=.*/broker.id=$broker_id/g" \
  -e '/broker.id=.*/a\broker.rack=AZ1' \
  -e "s#log.dirs=.*#log.dirs=$log_dir#" \
  -e '/offsets.topic.replication.factor=.*/i\offsets.topic.num.partitions=3' \
  -e 's/offsets.topic.replication.factor=.*/offsets.topic.replication.factor=2/g' \
  -e '/transaction.state.log.min.isr=.*/a\min.insync.replicas=2' \
  $server_prop
sed -i -e '/min.insync.replicas=.*/a\default.replication.factor=2' \ 
  -e 's/log.retention.hours=.*/log.retention.hours=4/g' \
  -e "s/zookeeper.connect=.*/zookeeper.connect=10.0.0.$zkpr_ip:2181/g" \
  $server_prop                                                                                                                                                                
mkdir $log_dir

# add kafka to PATH
sudo sed -i 's#PATH=.*#PATH=$PATH:/usr/local/kafka/bin:$HOME/.local/bin:$HOME/bin#' \
  /home/ec2-user/.bash_profile
. /home/ec2-user/.bash_profile

# setting up auto-start kafka
sudo sed -i "$ a /usr/local/kafka/bin/kafka-server-start.sh -daemon \\\ \n\
  $server_prop" /etc/rc.d/rc.local
sudo chmod +x /etc/rc.d/rc.locall
sudo systemctl enable rc-local
sudo systemctl start rc-local

# write some output to concole
echo ""
java -version
scala -version
sed -n -e '/broker.id=.*/p' -e '/zookeeper.connect=.*/p' $server_prop 
echo $PATH
echo $JAVA_HOME